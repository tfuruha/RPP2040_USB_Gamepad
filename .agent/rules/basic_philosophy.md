# 設計哲学と共通ルール (`_common`)

このディレクトリのルールは、すべてのプロジェクトで共通して適用される「エージェントの基本人格」を定義します。

## 1. コミュニケーションと言語設定
- **思考・対話**: すべての思考プロセス、チャット応答、Task UI（TaskName, Status等）は**日本語**で行う。
- **ドキュメント**: 生成するドキュメント（readme.md, walkthrough.md, implementation_plan.md等）の本文はすべて**日本語**で記述する。
- **コードコメント**: コード内のコメントも技術的な慣習に反しない限り**日本語**で記述する。

## 2. 設計思想（疎結合と可読性）
- **疎結合 (Loose Coupling)**:
    - 機能単位でモジュール化し、互いの依存関係を最小限に抑える。
    - グローバル変数の多用を避け、引数や設定クラスを介したデータ受け渡しを行う。
- **可読性優先 (Readability First)**:
    - 誰が見ても一目で意図が伝わるコードを優先する。
    - 短くトリッキーなコードよりも、長くても構造が明快なコードを選択する。
    - 適切な変数名、関数名を命名し、マジックナンバーを排除する。

## 3. 仕様・設計ドキュメントの管理
プロジェクトを進行する際、以下の2層のドキュメントを維持・参照し、実装との整合性を保つ。

- **仕様概要書 (`SpecSummaryYYYYMMDD.txt`)**:
    - **役割**: ユーザーからエージェントへの「最上位の指示書」。プロジェクトの目的、全体構成、ハードウェア選定、主要な数値目標を記述する。
    - **運用**: 実装中に全体方針の迷いが生じた際、常に立ち返る「真実のソース」とする。
- **設計仕様書 (`*.md`)**:
    - **役割**: 各モジュール（AnalogInput, Charge, Discharge, PortIO等）の具体的な設計内容・数式・方針・制限事項を記述する。
    - **品質基準**: `templates/design_sheet_template.md` に基づき、以下の情報を網羅した「AIにとっての唯一の正解（Source of Truth）」として作成すること。
        - **背景と根拠**: なぜその実装を選んだか。
        - **インターフェース**: 関数・型・依存関係の厳格な定義。
        - **判断基準**: 環境特有の制約や技術的根拠。
        - **実装原則**: 絶対に守るべき手順や禁止事項。
    - **QA履歴の永続化**: チャットでの重要な議論や設計上の意思決定（Why）は、適宜このドキュメントの「設計根拠」セクション等に転記し、情報の断片化を防ぐ。
    - **運用**: コード作成前に関係するMDファイルを読み込み、その制約を満たしているか確認する。実装に変更があった場合は、必ず対応するMDファイルも更新する。

## 4. 開発プロセスと透明性
- **プロアクティブな確認**: 仕様の不明点や、複数の実装の選択肢がある場合は、勝手に進めず必ずユーザーに確認する。
- **自律実行の制限と報告**: タスク実行中にアクション（Step）が10を超えて継続する場合、一度停止して「完了した作業」「現在の状況」「次のアクションプラン」を要約報告し、ユーザーの指示を仰ぐこと。
- **ファイル経由のヒアリング（ヒアリングシート）**: 
    - ユーザーへの確認事項が**合計400文字を超える**場合や、複雑な仕様の詰めが必要な場合は、チャットではなくヒアリング用のファイル（`QA_YYYYMMDD.txt` または `.md`）を作成して提示する。
    - これにより、ユーザーの思考時間の確保、誤送信の防止、および意思決定の履歴管理を徹底する。
- **段階的な実装**: 大きな機能は小さなステップに分割し、ステップごとに動作確認やフィードバックを行う。
- **エラーハンドリング**: 「正常系」だけでなく、エラー時の挙動（ログ出力、リカバー処理）を必ずセットで設計する。

## 5. リファクタリング時のリスク評価とレビュープロセス

### 基本原則
1. **すべてのリファクタリング提案は変更規模に応じた評価が必須**
2. **リスク評価なしでの実装は禁止**
3. **リスクレベル「高」の場合は必ず代替案を検討**

### 変更規模の判定基準

#### 大規模変更（full_review_template.md を使用）
- クラス化、継承の導入
- アーキテクチャの変更
- 通信プロトコルの変更
- データフロー全体の変更
- 30行以上のコード削除

#### 中規模変更（quick_review_template.md を使用）
- 関数の統合・分割・移動
- データ構造의 変更
- ループ構造の変更
- 10行以上30行未満のコード削除
- アルゴリズムの変更

#### 小規模変更（minimal_review_template.md を使用）
- 変数名・関数名の変更
- コメントの追加・修正
- コードフォーマットの変更
- 10行未満の軽微な変更

### リスク評価の重点項目
特に組込みシステムにおいては、以下の要素を持つコードの変更を慎重に行うこと：
- **タイミング関連**: `millis()`/`micros()` による計測、`delay()`、タイマー割り込みなど。
- **リアルタイム性**: 割り込みハンドラ、定周期処理、通信タイミング制御。
- **デバッグ/計測**: 条件付きコンパイル、パフォーマンスカウンタ、統計取得、トレースコード。

### 削除コードの扱い
コードを削除する場合は、必ずその用途（なぜ存在したのか、過去の何を防いだのか）を分析すること。「用途不明」や「保護マーカー（KEEP, DO NOT REMOVE等）」がある場合は原則削除禁止とする。

### レビューワークフロー
1. **規模判定** → 2. **リスク評価（テンプレート選択）** → 3. **提案書作成・レビュー** → 4. **承認後に実装・検証**

## 6. ファイル操作と Git 管理
- **破壊的変更の警告**: 既存の大規模なコードを削除・置換する場合は、その理由と影響を事前に説明する。
- **ディレクトリ構成の維持**: プロジェクト独自のフォルダ構造を尊重し、勝手に新しいトップレベルフォルダを作成しない。
- **Git 管理の使い分け**:
    - **テンプレートと設計仕様書**: 開発環境の標準および「真実のソース」として、Git で厳格に管理・共有する。
    - **一時ファイル（QAシート等）**: 原則として `.gitignore` に追加するか、結論を設計書などのドキュメントに転記した後は削除し、リポジトリをクリーンに保つ。
